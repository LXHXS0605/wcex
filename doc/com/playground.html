<template files.array="[]" size.int="14" class="shadow" ed-size.int="20">
  <meta name="scope" cur.int="1" />
  <meta name="module" pkg="lodash.debounce" cjs />
  <meta name="module" pkg="esbuild-wasm" content="lib/browser.min.js" cjs />

  <style>
    :host {
      display: flex;
      flex-direction: column;
      height: ":${size+edSize}em";
      border-radius: 5px;
      overflow: hidden;
      background-color: "$$color.bg.l5_";
      overflow: hidden;
    }
    #demo {
      display: block;
      overflow: hidden;
      height: ":${size}em";
      border: none;
      padding: 0;
      margin: 0;
    }
    #url {
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
      font-size: 0.6em;
      font-weight: 300;
    }
    #title {
      padding: 0.2em;
      display: flex;
      background-color: "$$color.bgr";
      color: "$$color.textr";
    }
    #title > * {
      padding: 0 0.1em;
    }
  </style>
  <div id="title">
    <wcex-ui.icon style="margin: 0 0.3em" icon="airplay" size="1"></wcex-ui.icon>
    <div>PLAYGROUND</div>

    <div id="url" style="flex: 1; text-align: center" $>files[0]</div>
    <wcex-ui.icon
      title="reload"
      icon="replay_circle_filled"
      $color="$color.sec"
      active
      size="1"
      @click="reload()"
    ></wcex-ui.icon>
    <wcex-ui.icon
      title="reset"
      icon="delete_forever"
      $color="$color.sec"
      active
      size="1"
      @click="resetCache()"
    ></wcex-ui.icon>
  </div>
  <!-- 示例区域 -->

  <iframe id="demo"></iframe>
  <!-- 编辑器 -->
  <wcex-ui.tab $tabs="files" style="flex: 1" $$="cur" @change.1="$emit('layout',$id['ed'+value]);">
    <wcex-ui.monaco
      slot="panel"
      :id="ed${index}"
      style="width: 100%; height: 100%"
      $file="playgroundPath(value)"
      @edit="onEdit($ev)"
      $for="files"
      $show="$root.cur==index"
    ></wcex-ui.monaco>
  </wcex-ui.tab>
  <script scope="debounce" src="lodash.debounce" nocall></script>
  <script scope="esbuild" src="esbuild-wasm" nocall nowatch></script>

  <script scope=".">
    let _INIT_ESBUILD = undefined;
    // 注意开发时iframe配置的同源问题,需要使用localhost访问
    return class {
      readyFlag = 0;
      async onReady() {
        if (!_INIT_ESBUILD) {
          _INIT_ESBUILD = this.esbuild.initialize({
            wasmURL: this.$path("@/esbuild-wasm/esbuild.wasm"),
          });
        }
        await _INIT_ESBUILD;
        await this.loadDemo();
        this.readyFlag = 1;
        this.$monitSize(this.$rootElem, () => {
          console.log("size--Changed");
          // 通知编辑器重新布局
          for (let i = 0; i < this.files.length; i++) {
            this.$emit("layout", this.$id["ed" + i]);
          }
        });
      }
      async buildTs(text) {
        return (
          (
            await this.esbuild.transform(text, {
              loader: "ts",
              format: "iife",
              globalName: "__export__",
              banner: `define(['require','exports'], function(require,exports) {`,
              footer: `console.log(exports);return __export__;});`,
            })
          ).code || ""
        );
      }
      lang() {
        return this.$router.route.default.attrs.lang;
      }
      baseUrl() {
        return this.$router.route.default.attrs.url;
      }

      playgroundPath(path) {
        return decodeURI(location.origin + "/__playground/" + this.baseUrl().replace(/\/.*$/, "/") + path);
      }

      docPath(path) {
        return decodeURI(this.$path("../guide/" + this.lang() + "/" + this.baseUrl().replace(/\/.*$/, "/") + path));
      }
      async swPost(type, data) {
        (await navigator.serviceWorker.getRegistration("/")).active.postMessage({
          type,
          data,
        });
      }
      async updateDemo(file) {
        let mainFile = this.playgroundPath(this.files[0]);
        if (file && file != mainFile) {
          //获取主index.html路径
          let p = mainFile.replace(/^(.*\/).*?$/, "$1");
          let f = file.replace(p, "");
          // 读取文件

          // 热更新
          this.$id.demo.contentWindow.dispatchEvent(new CustomEvent("wc-hotload", { detail: { path: f } }));
        } else {
          // 重新load
          this.$id.demo.contentWindow.location.reload();
        }
      }

      async updateCache(file, text) {
        if (file.endsWith(".ts")) {
          // 处理ts文件为js
          let jsText = await this.buildTs(text);
          await this.swPost("hotCacheSet", {
            file: file.replace(/\.ts$/, ".js"),
            text: jsText,
          });
        }
        await this.swPost("hotCacheSet", {
          file,
          text,
        });
      }

      async onEdit(ev) {
        if (ev) {
          // 向sw发送消息,更新缓存
          await this.updateCache(ev.detail.file, ev.detail.text);
          // await this.swPost("hotCacheSet", {
          //   file: ev.detail.file,
          //   text: ev.detail.text,
          // });
          setTimeout(() => {
            this.updateDemo(ev.detail.file);
          }, 200);
        }
      }
      reload() {
        this.$id.demo.contentWindow.location.reload();
      }
      async loadDemo() {
        if (!this.baseUrl()) return;
        // 加载数据
        let loadFiles = await Promise.all(
          this.files.map((f) => {
            return fetch(this.docPath(f))
              .then((r) => {
                return r.text();
              })
              .then((v) => {
                return {
                  url: this.playgroundPath(f),
                  text: v,
                };
              });
          })
        );

        // 更新缓存
        for (let f of loadFiles) {
          await this.updateCache(f.url, f.text);

          // await this.swPost("hotCacheSet", {
          //   file: f.url,
          //   text: f.text,
          // });
        }
        if (loadFiles.length > 0) this.$id.demo.src = loadFiles[0].url;
      }
      async resetCache() {
        await this.swPost("hotCacheClean", {});

        await this.loadDemo();
        // 通知编辑器重新加载
        for (let i = 0; i < this.files.length; i++) {
          this.$emit("reload", this.$id["ed" + i]);
        }
      }
    };
  </script>
</template>
