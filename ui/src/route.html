<!-- 
    处理路由: /#com-main?a=1&b=2;menu:com-menu?c=3&d=4
    路由匹配使用 match 参数
    路由异常通过 error 事件
 -->

<template name="default" home="" match="" data="">
  <meta name="scope" />
  <style>
    :host {
      display: block;
    }
  </style>
  <div>
    <div id="route" $as="component" $data="$root.data"></div>
  </div>
  <script scope=".">
    return class {
      component = "";
      changeRouter() {
        try {
          var r = this.$router.route[this.name];
          var rel = this.$id.route;
          var rsc = this.$id.route.$scope;
          if (!r) return;
          var tag = r.tag || this.home;
          if (!tag) return;
          if (this.match) {
            if (!r.tag.match(new RegExp(this.match))) throw Error("route invalid " + r.tag);
          }
          if (tag.indexOf("-") < 0) throw Error("invalid tag");
          if (rel) {
            // 首先设置属性
            for (var k of Object.keys(r.attrs)) {
              let v = r.attrs[k];
              this.$id.route.setAttribute(k, v);
              if (rsc && rsc.hasOwnProperty(k)) rsc[k] = v;
            }
            // 更新标签
            this.component = tag;
          } else {
            throw Error(`invalid route name:${this.name}`);
            this.$emit("error", { tag: r.tag });
          }
        } catch (e) {
          this.$log.error("router error:", e.message);
          this.$router.go(this.name,this.home)
          this.$emit("error");
        }
      }
      onReady() {
        window.addEventListener("route-change", () => {
          this.changeRouter();
        });
        window.addEventListener("wc-error", (ev) => {
          this.$log.error("route load failed:", ev);
          // 出现错误回首页
          this.$router.go(this.name, this.home);
          this.$emit("error");
        });
        // 初始化默认路由
        this.changeRouter();
      }
    };
  </script>
</template>
