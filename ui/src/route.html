<!-- 
    处理路由: /#com-main?a=1&b=2;menu:com-menu?c=3&d=4
    路由匹配使用 match 参数
    路由异常通过 error 事件
 -->

<template name="default" home="" match="" data="">
  <meta name="scope" />
  <style>
    :host {
      display: block;
    }
  </style>
  <div >
    <div id="route" $as="component" $data="$root.data"></div>
  </div>
  <script scope=".">
    return class {
      component = this.home;
      changeRouter() {
        var r = this.$router.route[this.name];
        var rel = this.$id.route;
        var rsc = this.$id.route.$scope;
        if(!r) return;
        if (this.match && r.tag) {
          if (!r.tag.match(new RegExp(this.match))) throw Error("route invalid " + r.tag);
        }
        if (r.tag.indexOf("-") < 0) throw Error("invalid tag");
        if (rel) {
          // 首先设置属性
          for (var k of Object.keys(r.attrs)) {
            let v = r.attrs[k];
            this.$id.route.setAttribute(k, v);
            if (rsc && rsc.hasOwnProperty(k)) rsc[k] = v;
          }
          // 更新标签
          this.component = r.tag;
        } else {
          throw Error(`invalid route name:${this.name}`);
          this.$emit("error", { tag: r.tag });
        }
      }
      onReady() {
        window.addEventListener("route-change", () => {
          try {
            this.changeRouter();
          } catch (e) {
            this.$log.error("change route fail: ", e.message);
          }
        });
        window.addEventListener("wc-error", (ev) => {
          this.$log.error('route error:',ev)
          // 错误进入首页
          var r = this.$router.route[this.name];
          if (ev.detail.tag === r.tag) {
            this.$emit("error", { tag: ev.detail.tag });
          }
        });

        var r = this.$router.route[this.name];
        if(r&&r.tag){
          this.$router.go(r.tag,r.attrs)
          this.changeRouter()
        }
        else this.changeRouter()

      }
    };
  </script>
</template>
